<!DOCTYPE html>
<html lang="en">
<head>
<title>SChannel helper: SChannel.Utils</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="PasDoc 0.15.0">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rel="StyleSheet" type="text/css" href="pasdoc.css">
</head>
<body>
<table class="container"><tr><td class="navigation">
<h2><a href="index.html" class="navigation">SChannel helper</a></h2><p><a href="AllUnits.html" class="navigation">Units</a></p><p><a href="ClassHierarchy.html" class="navigation">Class Hierarchy</a></p><p><a href="AllClasses.html" class="navigation">Classes, Interfaces, Objects and Records</a></p><p><a href="AllTypes.html" class="navigation">Types</a></p><p><a href="AllVariables.html" class="navigation">Variables</a></p><p><a href="AllConstants.html" class="navigation">Constants</a></p><p><a href="AllFunctions.html" class="navigation">Functions and Procedures</a></p><p><a href="AllIdentifiers.html" class="navigation">Identifiers</a></p></td><td class="content">
<h1 class="unit">Unit SChannel.Utils</h1>
<div class="sections">
<div class="one_section"><a class="section" href="#PasDoc-Description">Description</a></div><div class="one_section">Uses</div><div class="one_section"><a class="section" href="#PasDoc-Classes">Classes, Interfaces, Objects and Records</a></div><div class="one_section"><a class="section" href="#PasDoc-FuncsProcs">Functions and Procedures</a></div><div class="one_section"><a class="section" href="#PasDoc-Types">Types</a></div><div class="one_section"><a class="section" href="#PasDoc-Constants">Constants</a></div><div class="one_section"><a class="section" href="#PasDoc-Variables">Variables</a></div></div>
<span id="PasDoc-Description"></span><h2 class="description">Description</h2>
<p>
Helper functions for easy implementation of TLS communication by means of Windows SChannel. The functions are transport-agnostic so they could be applied to any socket implementation or even other transport.

<p>Inspired by <a href="http://www.coastrd.com/c-schannel-smtp">TLS-Sample</a>

<p>Uses <a href="https://jedi-apilib.sourceforge.net">JEDI API units</a>

<p>(c) Fr0sT-Brutal

<p>License MIT</p>
<span id="PasDoc-Uses"></span><h2 class="overview">Overview</h2>
<span id="PasDoc-Classes"></span><h3 class="cio">Classes, Interfaces, Objects and Records</h3>
<table class="classestable wide_list">
<tr class="listheader">
<th class="itemname">Name</th>
<th class="itemdesc">Description</th>
</tr>
<tr class="list">
<td class="itemname">Record&nbsp;<a class="bold" href="SChannel.Utils.THandShakeData.html"><code>THandShakeData</code></a></td>
<td class="itemdesc">United state and data for TLS handshake</td>
</tr>
<tr class="list2">
<td class="itemname">Record&nbsp;<a class="bold" href="SChannel.Utils.TSessionData.html"><code>TSessionData</code></a></td>
<td class="itemdesc">Data related to a session.</td>
</tr>
<tr class="list">
<td class="itemname">Record&nbsp;<a class="bold" href="SChannel.Utils.TBuffer.html"><code>TBuffer</code></a></td>
<td class="itemdesc">Trivial <a class="normal" href="SChannel.Utils.TBuffer.html#Data">data</a> storage</td>
</tr>
<tr class="list2">
<td class="itemname">Interface&nbsp;<a class="bold" href="SChannel.Utils.ISharedSessionData.html"><code>ISharedSessionData</code></a></td>
<td class="itemdesc">Interface with session data for sharing credentials</td>
</tr>
<tr class="list">
<td class="itemname">Class&nbsp;<a class="bold" href="SChannel.Utils.TSharedSessionData.html"><code>TSharedSessionData</code></a></td>
<td class="itemdesc">Interfaced object with session data for sharing credentials</td>
</tr>
<tr class="list2">
<td class="itemname">Class&nbsp;<a class="bold" href="SChannel.Utils.ESSPIError.html"><code>ESSPIError</code></a></td>
<td class="itemdesc">Specific exception class.</td>
</tr>
</table>
<span id="PasDoc-FuncsProcs"></span><h3 class="summary">Functions and Procedures</h3>
<table class="summary wide_list">
<tr class="list">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#LoadSecurityLibrary">LoadSecurityLibrary</a></strong>;</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#CreateCredentials">CreateCredentials</a></strong>(const User: string; out hCreds: CredHandle; var SchannelCred: SCHANNEL_CRED);</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#VerifyServerCertificate">VerifyServerCertificate</a></strong>(pServerCert: PCCERT_CONTEXT; const szServerName: string; dwCertFlags: DWORD);</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#Init">Init</a></strong>;</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#Fin">Fin</a></strong>;</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#InitSession">InitSession</a></strong>(var SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>);</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#FinSession">FinSession</a></strong>(var SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>);</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>function <strong><a href="SChannel.Utils.html#DoClientHandshake">DoClientHandshake</a></strong>(var SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>; var HandShakeData: <a href="SChannel.Utils.THandShakeData.html">THandShakeData</a>): SECURITY_STATUS;</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#GetShutdownData">GetShutdownData</a></strong>(const SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>; const hContext: CtxtHandle; out OutBuffer: SecBuffer);</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#CheckServerCert">CheckServerCert</a></strong>(const hContext: CtxtHandle; const ServerName: string);</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#DeleteContext">DeleteContext</a></strong>(var hContext: CtxtHandle);</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#InitBuffers">InitBuffers</a></strong>(const hContext: CtxtHandle; out pbIoBuffer: TBytes; out Sizes: SecPkgContext_StreamSizes);</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>procedure <strong><a href="SChannel.Utils.html#EncryptData">EncryptData</a></strong>(const hContext: CtxtHandle; const Sizes: SecPkgContext_StreamSizes; pbMessage: PByte; cbMessage: DWORD; pbIoBuffer: PByte; pbIoBufferLength: DWORD; out cbWritten: DWORD);</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>function <strong><a href="SChannel.Utils.html#DecryptData">DecryptData</a></strong>(const hContext: CtxtHandle; const Sizes: SecPkgContext_StreamSizes; pbIoBuffer: PByte; var cbEncData: DWORD; pbDecData: PByte; cbDecDataLength: DWORD; out cbWritten: DWORD): SECURITY_STATUS;</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>function <strong><a href="SChannel.Utils.html#SecIsNullHandle">SecIsNullHandle</a></strong>(const x: SecHandle): Boolean;</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>function <strong><a href="SChannel.Utils.html#SecStatusErrStr">SecStatusErrStr</a></strong>(scRet: SECURITY_STATUS): string;</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code>function <strong><a href="SChannel.Utils.html#WinVerifyTrustErrorStr">WinVerifyTrustErrorStr</a></strong>(Status: DWORD): string;</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code>function <strong><a href="SChannel.Utils.html#IsWinHandshakeBug">IsWinHandshakeBug</a></strong>(scRet: SECURITY_STATUS): Boolean;</code></td>
</tr>
</table>
<span id="PasDoc-Types"></span><h3 class="summary">Types</h3>
<table class="summary wide_list">
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#THandShakeStage">THandShakeStage</a></strong> = (...);</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#TChannelState">TChannelState</a></strong> = (...);</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#TSessionFlag">TSessionFlag</a></strong> = (...);</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#TSessionFlags">TSessionFlags</a></strong> = set of <a href="SChannel.Utils.html#TSessionFlag">TSessionFlag</a>;</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#PSessionData">PSessionData</a></strong> = &circ;<a href="SChannel.Utils.TSessionData.html">TSessionData</a>;</code></td>
</tr>
</table>
<span id="PasDoc-Constants"></span><h3 class="summary">Constants</h3>
<table class="summary wide_list">
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#LogPrefix">LogPrefix</a></strong> = '[SChannel]: ';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#IO_BUFFER_SIZE">IO_BUFFER_SIZE</a></strong> = $10000;</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#USED_PROTOCOLS">USED_PROTOCOLS</a></strong>: DWORD = SP_PROT_TLS1_1 or SP_PROT_TLS1_2;</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#USED_ALGS">USED_ALGS</a></strong>: ALG_ID = 0;</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_Received">S_Msg_Received</a></strong> = 'Received %d bytes of encrypted data / %d bytes of payload';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_SessionClosed">S_Msg_SessionClosed</a></strong> = 'Server closed the session [SEC_I_CONTEXT_EXPIRED]';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_Renegotiate">S_Msg_Renegotiate</a></strong> = 'Server requested renegotiate';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_Sending">S_Msg_Sending</a></strong> = 'Sending %d bytes of payload / %d bytes encrypted';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_StartingTLS">S_Msg_StartingTLS</a></strong> = 'Starting TLS handshake';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HShStageW1Success">S_Msg_HShStageW1Success</a></strong> = 'Handshake @W1 - %d bytes sent';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HShStageW1Fail">S_Msg_HShStageW1Fail</a></strong> = 'Handshake @W1 - ! error sending data';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HShStageRFail">S_Msg_HShStageRFail</a></strong> = 'Handshake @R - no data received or error receiving';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HShStageRSuccess">S_Msg_HShStageRSuccess</a></strong> = 'Handshake @R - %d bytes received';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HandshakeBug">S_Msg_HandshakeBug</a></strong> = 'Handshake bug: &quot;%s&quot;, retrying';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HShStageW2Success">S_Msg_HShStageW2Success</a></strong> = 'Handshake @W2 - %d bytes sent';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HShStageW2Fail">S_Msg_HShStageW2Fail</a></strong> = 'Handshake @W2 - ! error sending data';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_HShExtraData">S_Msg_HShExtraData</a></strong> = 'Handshake: got &quot;%d&quot; bytes of extra data';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_Established">S_Msg_Established</a></strong> = 'Handshake established';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_SrvCredsAuth">S_Msg_SrvCredsAuth</a></strong> = 'Server credentials authenticated';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_CredsInited">S_Msg_CredsInited</a></strong> = 'Credentials initialized';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_ShuttingDownTLS">S_Msg_ShuttingDownTLS</a></strong> = 'Shutting down TLS';</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Msg_SendingShutdown">S_Msg_SendingShutdown</a></strong> = 'Sending shutdown notify - %d bytes of data';</code></td>
</tr>
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#S_Err_ListeningNotSupported">S_Err_ListeningNotSupported</a></strong> = 'Listening is not supported with SChannel yet';</code></td>
</tr>
</table>
<span id="PasDoc-Variables"></span><h3 class="summary">Variables</h3>
<table class="summary wide_list">
<tr class="list">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#hMYCertStore">hMYCertStore</a></strong>: HCERTSTORE = nil;</code></td>
</tr>
<tr class="list2">
<td class="itemcode"><code><strong><a href="SChannel.Utils.html#g_pSSPI">g_pSSPI</a></strong>: PSecurityFunctionTable;</code></td>
</tr>
</table>
<h2 class="description">Description</h2>
<h3 class="detail">Functions and Procedures</h3>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="LoadSecurityLibrary"></span><code>procedure <strong>LoadSecurityLibrary</strong>;</code></td>
</tr>
<tr><td colspan="1">
<p>
Mainly for internal use </p>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="CreateCredentials"></span><code>procedure <strong>CreateCredentials</strong>(const User: string; out hCreds: CredHandle; var SchannelCred: SCHANNEL_CRED);</code></td>
</tr>
<tr><td colspan="1">
<p>
Mainly for internal use  </p>
<h6 class="description_section">Parameters</h6>
<dl class="parameters">
<dt>SchannelCred</dt>
<dd>- [?IN/OUT] If <code>SchannelCred.dwVersion</code> = <code>SCHANNEL_CRED_VERSION</code>, the parameter is considered &quot;IN/OUT&quot; and won't be modified before <code>AcquireCredentialsHandle</code> call. Otherwise the parameter is considered &quot;OUT&quot; and is init-ed with default values. Thus user can pass desired values to <code>AcquireCredentialsHandle</code> function.</dd>
</dl>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="VerifyServerCertificate"></span><code>procedure <strong>VerifyServerCertificate</strong>(pServerCert: PCCERT_CONTEXT; const szServerName: string; dwCertFlags: DWORD);</code></td>
</tr>
<tr><td colspan="1">
<p>
Mainly for internal use. Gets called by <code><a class="normal" href="SChannel.Utils.html#CheckServerCert">CheckServerCert</a></code> </p>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="Init"></span><code>procedure <strong>Init</strong>;</code></td>
</tr>
<tr><td colspan="1">
<p>
Load global stuff. Must be called before any other function called. Could be called multiple times without checks. <br> <strong>Thread-unsafe! Uses global variables</strong> </p>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="Fin"></span><code>procedure <strong>Fin</strong>;</code></td>
</tr>
<tr><td colspan="1">
<p>
Dispose and nullify global stuff. Could be called multiple times without checks. <br> <strong>Thread-unsafe! Uses global variables</strong></p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="InitSession"></span><code>procedure <strong>InitSession</strong>(var SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>);</code></td>
</tr>
<tr><td colspan="1">
<p>
Init session, return data record to be used in calling other functions. Could be called multiple times (nothing will be done on already init-ed record)  </p>
<h6 class="description_section">Parameters</h6>
<dl class="parameters">
<dt>SessionData</dt>
<dd>- [IN, OUT] record that receives values. On first call must be zeroed. Alternatively, user could fill <code>SessionData.SchannelCred</code> with desired values to tune channel properties.</dd>
</dl>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="FinSession"></span><code>procedure <strong>FinSession</strong>(var SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>);</code></td>
</tr>
<tr><td colspan="1">
<p>
Finalize session</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="DoClientHandshake"></span><code>function <strong>DoClientHandshake</strong>(var SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>; var HandShakeData: <a href="SChannel.Utils.THandShakeData.html">THandShakeData</a>): SECURITY_STATUS;</code></td>
</tr>
<tr><td colspan="1">
<p>
Function to prepare all necessary handshake data. No transport level actions. 

<p>Function to prepare all necessary handshake data. No transport level actions.    Function actions and returning data depending on input stage: </p>

<ul class="paragraph_spacing">
  <li><p><code>HandShakeData.Stage</code> = <a class="normal" href="SChannel.Utils.html#hssNotStarted">hssNotStarted</a>. Generate client hello. <br> <em>Output stage</em>: <a class="normal" href="SChannel.Utils.html#hssSendCliHello">hssSendCliHello</a>. <br> <em>Caller action</em>: send returned data (client hello) to server <br> <em>Input data</em>: </p>

<ul class="paragraph_spacing">
  <li><p>ServerName - host we're connecting to</p></li>
</ul>

<p> <em>Output data</em>: </p>

<ul class="paragraph_spacing">
  <li><p>hContext - handle to secure context</p></li>
  <li><p>OutBuffers - array with single item that must be finally disposed with <code>g_pSSPI.FreeContextBuffer</code></p></li>
</ul>

<p></p></li>
  <li><p><code>HandShakeData.Stage</code> = <a class="normal" href="SChannel.Utils.html#hssSendCliHello">hssSendCliHello</a>. <strong>Not</strong> handled by <code>DoClientHandshake</code> <br></p></li>
  <li><p><code>HandShakeData.Stage</code> = <a class="normal" href="SChannel.Utils.html#hssReadSrvHello">hssReadSrvHello</a>, <a class="normal" href="SChannel.Utils.html#hssReadSrvHelloNoRead">hssReadSrvHelloNoRead</a>, <a class="normal" href="SChannel.Utils.html#hssReadSrvHelloContNeed">hssReadSrvHelloContNeed</a>. Handle server hello

<p><em>Output stage</em>: <a class="normal" href="SChannel.Utils.html#hssReadSrvHello">hssReadSrvHello</a>, <a class="normal" href="SChannel.Utils.html#hssReadSrvHelloNoRead">hssReadSrvHelloNoRead</a>, <a class="normal" href="SChannel.Utils.html#hssReadSrvHelloContNeed">hssReadSrvHelloContNeed</a>, <a class="normal" href="SChannel.Utils.html#hssReadSrvHelloOK">hssReadSrvHelloOK</a>. <br> <em>Caller action</em>: </p>

<ul class="paragraph_spacing">
  <li><p><a class="normal" href="SChannel.Utils.html#hssReadSrvHello">hssReadSrvHello</a>: read data from server and call <code>DoClientHandshake</code> again</p></li>
  <li><p><a class="normal" href="SChannel.Utils.html#hssReadSrvHelloNoRead">hssReadSrvHelloNoRead</a>: call <code>DoClientHandshake</code> again without reading</p></li>
  <li><p><a class="normal" href="SChannel.Utils.html#hssReadSrvHelloContNeed">hssReadSrvHelloContNeed</a>: send token returned in <code>OutBuffers</code> and call <code>DoClientHandshake</code> again</p></li>
  <li><p><a class="normal" href="SChannel.Utils.html#hssReadSrvHelloOK">hssReadSrvHelloOK</a>: send token returned in <code>OutBuffers</code> and finish</p></li>
</ul>

<p> <em>Input data</em>: </p>

<ul class="paragraph_spacing">
  <li><p>ServerName - host we're connecting to</p></li>
  <li><p>IoBuffer - buffer with data from server</p></li>
  <li><p>cbIoBuffer - size of data in buffer</p></li>
</ul>

<p> <em>Output data</em>: </p>

<ul class="paragraph_spacing">
  <li><p>IoBuffer - buffer with unprocessed data from server</p></li>
  <li><p>cbIoBuffer - length of unprocessed data from server</p></li>
  <li><p>OutBuffers - array with single item that must be finally disposed with <code>g_pSSPI.FreeContextBuffer</code> (<a class="normal" href="SChannel.Utils.html#hssReadSrvHelloContNeed">hssReadSrvHelloContNeed</a>, <a class="normal" href="SChannel.Utils.html#hssReadSrvHelloOK">hssReadSrvHelloOK</a>)</p></li>
</ul>

<p></p></li>
  <li><p><code>HandShakeData.Stage</code> = <a class="normal" href="SChannel.Utils.html#hssReadSrvHelloOK">hssReadSrvHelloOK</a>. <strong>Not</strong> handled by <code>DoClientHandshake</code> <br></p></li>
  <li><p><code>HandShakeData.Stage</code> = <a class="normal" href="SChannel.Utils.html#hssDone">hssDone</a>. <strong>Not</strong> handled by <code>DoClientHandshake</code> <br></p></li>
</ul>

<p></p>
<h6 class="description_section">Parameters</h6>
<dl class="parameters">
<dt>SessionData</dt>
<dd>- [IN/OUT] record with session data</dd>
<dt>HandShakeData</dt>
<dd>- [IN/OUT] record with handshake data</dd>
</dl>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="GetShutdownData"></span><code>procedure <strong>GetShutdownData</strong>(const SessionData: <a href="SChannel.Utils.TSessionData.html">TSessionData</a>; const hContext: CtxtHandle; out OutBuffer: SecBuffer);</code></td>
</tr>
<tr><td colspan="1">
<p>
Generate data to send to a server on connection shutdown </p>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="CheckServerCert"></span><code>procedure <strong>CheckServerCert</strong>(const hContext: CtxtHandle; const ServerName: string);</code></td>
</tr>
<tr><td colspan="1">
<p>
Check server certificate </p>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="DeleteContext"></span><code>procedure <strong>DeleteContext</strong>(var hContext: CtxtHandle);</code></td>
</tr>
<tr><td colspan="1">
<p>
Dispose and nullify security context</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="InitBuffers"></span><code>procedure <strong>InitBuffers</strong>(const hContext: CtxtHandle; out pbIoBuffer: TBytes; out Sizes: SecPkgContext_StreamSizes);</code></td>
</tr>
<tr><td colspan="1">
<p>
Receive size values for current session and init buffer length to contain full message including header and trailer </p>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="EncryptData"></span><code>procedure <strong>EncryptData</strong>(const hContext: CtxtHandle; const Sizes: SecPkgContext_StreamSizes; pbMessage: PByte; cbMessage: DWORD; pbIoBuffer: PByte; pbIoBufferLength: DWORD; out cbWritten: DWORD);</code></td>
</tr>
<tr><td colspan="1">
<p>
Encrypt data (prepare for sending to server).        </p>
<h6 class="description_section">Parameters</h6>
<dl class="parameters">
<dt>hContext</dt>
<dd>- current session context</dd>
<dt>Sizes</dt>
<dd>- current session sizes</dd>
<dt>pbMessage</dt>
<dd>- input data to encrypt</dd>
<dt>cbMessage</dt>
<dd>- length of input data</dd>
<dt>pbIoBuffer</dt>
<dd>- buffer to receive encrypted data</dd>
<dt>pbIoBufferLength</dt>
<dd>- size of buffer</dd>
<dt>cbWritten</dt>
<dd>- [OUT] size of encrypted data written to buffer</dd>
</dl>
<h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="DecryptData"></span><code>function <strong>DecryptData</strong>(const hContext: CtxtHandle; const Sizes: SecPkgContext_StreamSizes; pbIoBuffer: PByte; var cbEncData: DWORD; pbDecData: PByte; cbDecDataLength: DWORD; out cbWritten: DWORD): SECURITY_STATUS;</code></td>
</tr>
<tr><td colspan="1">
<p>
Decrypt data received from server. If input data is not processed completely, unprocessed chunk is copied to beginning of buffer. Thus subsequent call to Recv could just receive to @Buffer[DataLength]         </p>
<h6 class="description_section">Parameters</h6>
<dl class="parameters">
<dt>hContext</dt>
<dd>- current session context</dd>
<dt>Sizes</dt>
<dd>- current session sizes</dd>
<dt>pbIoBuffer</dt>
<dd>- input encrypted data to decrypt</dd>
<dt>cbEncData</dt>
<dd>- [IN/OUT] length of encrypted data in buffer. After function call it is set to amount of unprocessed data that is placed from the beginning of the buffer</dd>
<dt>pbDecData</dt>
<dd>- buffer to receive decrypted data</dd>
<dt>cbDecDataLength</dt>
<dd>- size of buffer</dd>
<dt>cbWritten</dt>
<dd>- [OUT] size of decrypted data written to buffer</dd>
</dl>
<h6 class="description_section">Returns</h6>
<p class="return"> </p>

<ul class="paragraph_spacing">
  <li><p><code>SEC_I_CONTEXT_EXPIRED</code> - server signaled end of session</p></li>
  <li><p><code>SEC_E_OK</code> - message processed fully</p></li>
  <li><p><code>SEC_E_INCOMPLETE_MESSAGE</code> - need more data</p></li>
  <li><p><code>SEC_I_RENEGOTIATE</code> - server wants to perform another handshake sequence</p></li>
</ul>

<p></p><h6 class="description_section">Exceptions raised</h6>
<dl class="exceptions_raised">
<dt><a class="normal" href="SChannel.Utils.ESSPIError.html">ESSPIError</a></dt>
<dd>on error or if Result is not one of above mentioned values</dd>
</dl>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="SecIsNullHandle"></span><code>function <strong>SecIsNullHandle</strong>(const x: SecHandle): Boolean;</code></td>
</tr>
<tr><td colspan="1">
<p>
Check if handle <code>x</code> is null (has both fields equal to zero)</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="SecStatusErrStr"></span><code>function <strong>SecStatusErrStr</strong>(scRet: SECURITY_STATUS): string;</code></td>
</tr>
<tr><td colspan="1">
<p>
Returns string representaion of given security status</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="WinVerifyTrustErrorStr"></span><code>function <strong>WinVerifyTrustErrorStr</strong>(Status: DWORD): string;</code></td>
</tr>
<tr><td colspan="1">
<p>
Returns string representaion of given verify trust error</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="IsWinHandshakeBug"></span><code>function <strong>IsWinHandshakeBug</strong>(scRet: SECURITY_STATUS): Boolean;</code></td>
</tr>
<tr><td colspan="1">
<p>
Check if status is likely a Windows TLS v1.2 handshake bug (<code>SEC_E_BUFFER_TOO_SMALL</code> or <code>SEC_E_MESSAGE_ALTERED</code> status is returned by <code>InitializeSecurityContext</code> on handshake). This function only checks if parameter is one of these two values.</p>
</td></tr>
</table>
<h3 class="detail">Types</h3>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="THandShakeStage"></span><code><strong>THandShakeStage</strong> = (...);</code></td>
</tr>
<tr><td colspan="1">
<p>
Stage of handshake</p>
<h6 class="description_section">Values</h6>
<ul>
<li>
<span id="hssNotStarted">hssNotStarted</span>: Initial stage</li>
<li>
<span id="hssSendCliHello">hssSendCliHello</span>: Sending client hello</li>
<li>
<span id="hssReadSrvHello">hssReadSrvHello</span>: Reading server hello - general</li>
<li>
<span id="hssReadSrvHelloNoRead">hssReadSrvHelloNoRead</span>: Reading server hello - repeat call without reading</li>
<li>
<span id="hssReadSrvHelloContNeed">hssReadSrvHelloContNeed</span>: Reading server hello - in process, send token</li>
<li>
<span id="hssReadSrvHelloOK">hssReadSrvHelloOK</span>: Reading server hello - success, send token</li>
<li>
<span id="hssDone">hssDone</span>: Final stage</li>
</ul>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="TChannelState"></span><code><strong>TChannelState</strong> = (...);</code></td>
</tr>
<tr><td colspan="1">
<p>
State of secure channel</p>
<h6 class="description_section">Values</h6>
<ul>
<li>
<span id="chsNotStarted">chsNotStarted</span>: Initial stage</li>
<li>
<span id="chsHandshake">chsHandshake</span>: Handshaking with server</li>
<li>
<span id="chsEstablished">chsEstablished</span>: Channel established successfully</li>
<li>
<span id="chsShutdown">chsShutdown</span>: Sending shutdown signal and closing connection</li>
</ul>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="TSessionFlag"></span><code><strong>TSessionFlag</strong> = (...);</code></td>
</tr>
<tr><td colspan="1">
<p>
Session options</p>
<h6 class="description_section">Values</h6>
<ul>
<li>
<span id="sfNoServerVerify">sfNoServerVerify</span>: If <code>True</code>, SChannel won't verify server certificate (use with care! Though this could help when connecting by IP)</li>
</ul>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="TSessionFlags"></span><code><strong>TSessionFlags</strong> = set of <a href="SChannel.Utils.html#TSessionFlag">TSessionFlag</a>;</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="PSessionData"></span><code><strong>PSessionData</strong> = &circ;<a href="SChannel.Utils.TSessionData.html">TSessionData</a>;</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<h3 class="detail">Constants</h3>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="LogPrefix"></span><code><strong>LogPrefix</strong> = '[SChannel]: ';</code></td>
</tr>
<tr><td colspan="1">
<p>
Just a suggested prefix for log output</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="IO_BUFFER_SIZE"></span><code><strong>IO_BUFFER_SIZE</strong> = $10000;</code></td>
</tr>
<tr><td colspan="1">
<p>
Size of handshake buffer</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="USED_PROTOCOLS"></span><code><strong>USED_PROTOCOLS</strong>: DWORD = SP_PROT_TLS1_1 or SP_PROT_TLS1_2;</code></td>
</tr>
<tr><td colspan="1">
<p>
Set of used protocols. Note: TLS 1.0 is not used by default, add <code>SP_PROT_TLS1_0</code> if needed</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="USED_ALGS"></span><code><strong>USED_ALGS</strong>: ALG_ID = 0;</code></td>
</tr>
<tr><td colspan="1">
<p>
Set of used algorithms. <code>0</code> means default. Add <code>CALG_DH_EPHEM</code>, <code>CALG_RSA_KEYX</code>, etc if needed</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_Received"></span><code><strong>S_Msg_Received</strong> = 'Received %d bytes of encrypted data / %d bytes of payload';</code></td>
</tr>
<tr><td colspan="1">
<p>
Messages that could be written to log by various implementations. None of these are used in this unit</p>
</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_SessionClosed"></span><code><strong>S_Msg_SessionClosed</strong> = 'Server closed the session [SEC_I_CONTEXT_EXPIRED]';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_Renegotiate"></span><code><strong>S_Msg_Renegotiate</strong> = 'Server requested renegotiate';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_Sending"></span><code><strong>S_Msg_Sending</strong> = 'Sending %d bytes of payload / %d bytes encrypted';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_StartingTLS"></span><code><strong>S_Msg_StartingTLS</strong> = 'Starting TLS handshake';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HShStageW1Success"></span><code><strong>S_Msg_HShStageW1Success</strong> = 'Handshake @W1 - %d bytes sent';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HShStageW1Fail"></span><code><strong>S_Msg_HShStageW1Fail</strong> = 'Handshake @W1 - ! error sending data';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HShStageRFail"></span><code><strong>S_Msg_HShStageRFail</strong> = 'Handshake @R - no data received or error receiving';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HShStageRSuccess"></span><code><strong>S_Msg_HShStageRSuccess</strong> = 'Handshake @R - %d bytes received';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HandshakeBug"></span><code><strong>S_Msg_HandshakeBug</strong> = 'Handshake bug: &quot;%s&quot;, retrying';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HShStageW2Success"></span><code><strong>S_Msg_HShStageW2Success</strong> = 'Handshake @W2 - %d bytes sent';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HShStageW2Fail"></span><code><strong>S_Msg_HShStageW2Fail</strong> = 'Handshake @W2 - ! error sending data';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_HShExtraData"></span><code><strong>S_Msg_HShExtraData</strong> = 'Handshake: got &quot;%d&quot; bytes of extra data';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_Established"></span><code><strong>S_Msg_Established</strong> = 'Handshake established';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_SrvCredsAuth"></span><code><strong>S_Msg_SrvCredsAuth</strong> = 'Server credentials authenticated';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_CredsInited"></span><code><strong>S_Msg_CredsInited</strong> = 'Credentials initialized';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_ShuttingDownTLS"></span><code><strong>S_Msg_ShuttingDownTLS</strong> = 'Shutting down TLS';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Msg_SendingShutdown"></span><code><strong>S_Msg_SendingShutdown</strong> = 'Sending shutdown notify - %d bytes of data';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="S_Err_ListeningNotSupported"></span><code><strong>S_Err_ListeningNotSupported</strong> = 'Listening is not supported with SChannel yet';</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<h3 class="detail">Variables</h3>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="hMYCertStore"></span><code><strong>hMYCertStore</strong>: HCERTSTORE = nil;</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<table class="detail wide_list">
<tr class="list">
<td class="itemcode"><span id="g_pSSPI"></span><code><strong>g_pSSPI</strong>: PSecurityFunctionTable;</code></td>
</tr>
<tr><td colspan="1">
&nbsp;</td></tr>
</table>
<hr><span class="appinfo"><em>Generated by <a href="https://github.com/pasdoc/pasdoc/wiki">PasDoc 0.15.0</a>. </em>
</span>
</td></tr></table></body></html>
